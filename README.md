# code-blocks

Parse [fenced code blocks] from [Markdown] with useful metadata.

```
npm install [--save | --save-dev] code-blocks
```

## How it works

This library uses [remark] to parse Markdown into a [unist] tree, then finds
all of the `code` nodes in the tree with a `lang` property; that is, [fenced
code blocks] with a language identifier after the opening <code>```</code> or
<code>~~~</code>, such as:

~~~
```html
<h1>Hello, world!</h1>
```
~~~

### Code block info

The [CommonMark Spec][fenced code blocks] states that:

> The first word of the info string is typically used to specify the language
> of the code sample, and rendered in the class attribute of the code tag.
> However, this spec does not mandate any particular treatment of the info
> string.

In other words, CommonMark-compliant parsers should safely ignore everything
after the language identifier. That's where we can attach additional key/value
pairs, which are parsed as each code block's `info`, as in:

~~~markdown
```html title="A dumb example" foo=bar "x.y.z"="1 2 3"
<h1>Hello, world!</h1>
```
~~~

The [unist] node objects returned by all of the block parsing
functions are "enhanced" with the following keys:

* `lang` contains only the first "word" of the info string
* `info` is an object of key/value pairs parsed from the remainder of the info
  string
* `title` is the title of the code block, as determined by [this
  algorithm](#code-block-titles)
* `source` is an object with two keys:
    * `file` is the path provided as the first argument to
      `fromFile()` and `fromFileSync()`, or as the last argument
      to `fromString()` or `fromAST()`. (If no file is provided,
      this value will be `buffer`.)
    * `line` is the starting line of the code block in markdown
      input.

See the [mdast] documentation for more info about the [Code
nodes](https://github.com/syntax-tree/mdast#code) generated by
[remark], and the [unist] documentation for more on the
[underlying structures](https://github.com/syntax-tree/unist#unist-nodes).

### Code block titles

Because code blocks are often meaningless without at least some context, every
block parsed gets a title according to the following algorithm:

1. If a `title` key is found in the block's `info` key, use that.
1. Otherwise, find the previous heading in the markdown and use its text.
    1. If two or more code blocks share the same heading, add a numeric suffix:
    `(2)` for the second, `(3)` for the third, and so on.
1. If no previous heading is found, provide a title that describes where it
   comes from, in the form:

   ```
   Code block {n} from {filename}:{line}
   ```

   Where `{n}` is the 1-based index of the code block in the parsed file,
   `{filename}` is the parsed file (or `buffer`), and `{line}` is the line at
   which the code block starts. You can customize the format of this title with
   the [`title` option](#title)


## API

### `fromFile(filename[, options])`

Read a file asynchronously and parse all of the code blocks from it. Paths are
relative to the current working directory (`process.cwd()`) unless they're
specified absolutely. `fromFile()` returns a [Promise] that resolves to an
array of code block objects:

```js
const codeBlocks = require('code-blocks')
codeBlocks.fromFile('README.md')
  .then(blocks => {
    // do stuff with the blocks here
  })
```

### `fromFileSync(filename[, options])`

This is the synchronous version of [`fromFile()`]:

```js
const codeBlocks = require('code-blocks')
const blocks = codeBlocks.fromFileSync('README.md')
// do stuff with the blocks here
```

[abstract syntax tree]: https://en.wikipedia.org/wiki/Abstract_syntax_tree
[fenced code blocks]: http://spec.commonmark.org/0.12/#fenced-code-blocks
[markdown]: https://en.wikipedia.org/wiki/Markdown
[unist]: https://unifiedjs.github.io/#syntax-tree
[mdast]: https://github.com/syntax-tree/mdast
[remark]: https://github.com/wooorm/remark
